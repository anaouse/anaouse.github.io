---
title: å®žçŽ°3
date: 2025-07-15
author: anaouse
layout: doc
---

## å®å’šé¸¡ä¸Žå“ˆåŸºç±³

å®å’šé¸¡æ˜¯ä¸€åªæ‹¿ç€å–‡å­çš„é¸¡ï¼Œæ¯å¤©åªä¼šä¸€ç›´å«è‡ªå·±åå­—ï¼Œä¸å¯¹ï¼Œåº”è¯¥æ˜¯æŠŠè‡ªå·±çš„åå­—å”±å‡ºæ¥ã€‚

å®å’šé¸¡éšèº«æºå¸¦å…´å¥‹å‰‚ï¼Œä¸çŸ¥é“æœ‰ä»€ä¹ˆç”¨ï¼Œè¯´å®žè¯ï¼Œé™¤äº†ç”¨æ¥åœ¨ä½“è‚²ç«žæŠ€æ¯”èµ›å½“ä¸­ä½œå¼Šï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“å…´å¥‹å‰‚æœ‰ä»€ä¹ˆç”¨ã€‚å¯èƒ½å®å’šé¸¡ä¸ºäº†è®©è‡ªå·±ä¸€ç›´äº¢å¥‹ï¼Œè¿™æ ·æ‰æœ‰åŠ›æ°”ä¸€ç›´ç”¨å–‡å­æ¥å¤§å–Šå¤§å«ã€‚

å“ˆåŸºç±³æ˜¯ä¸€ç§ç¥žç§˜çš„ä¸ä¸ºäººçŸ¥çš„ç‰©ç§ï¼ŒåªçŸ¥é“å“ˆåŸºXæˆä¸ºä¸€ç§ç¥žç§˜çš„é‚ªæ•™å¼çš„è¯­è¨€ï¼Œå“ˆåŸºç±³å¯ä»¥æ˜¯æŒ‡çŒ«ï¼Œå“ˆåŸºæœ¨æŒ‡çš„æ˜¯æœ¨å¤´ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥æ˜¯å¤±åŽ»å‰é¢ä¸¤æ¡è…¿çš„çŒ«ã€‚è¿™ä¸ªè¯è¯»èµ·æ¥å¾ˆçˆ½ï¼Œå¯èƒ½å°±æ˜¯é‚£ä¹ˆç®€å•çš„åŽŸå› ã€‚è™½ç„¶æ¥è‡ªåŠ¨ç”»ï¼Œä½†æ˜¯ä¸€å¼€å§‹åº”è¯¥å¤§å¤šæ•°äººéƒ½æ˜¯ç”¨æ¥æŒ‡å°çŒ«çš„ã€‚

è±ªçŒ«ï¼ŒðŸ—¡çŒ«éƒ½å¯ä»¥ç”¨å“ˆåŸºç±³æ¥ä»£æ›¿ã€‚å¯¹çŒ«çš„å–œçˆ±å’Œæ„¤æ€’ï¼Œå¯¹è™çŒ«è›†çš„åå¯¹ä¸Žæ”¯æŒï¼Œä»¥åŠåŽŸæœ¬å£°ä¼˜çš„å£°éŸ³å¥½å¬æ´—è„‘ç­‰ç­‰èƒ½å¤Ÿè°ƒåŠ¨æƒ…ç»ªçš„å› ç´ è¯žç”Ÿäº†å“ˆåŸºç±³è¿™ä¸ªäº§ç‰©ã€‚

å®å’šé¸¡æ˜¯å®ƒçš„å›¢é˜Ÿä¸­æœ€æœ‰åçš„ï¼Œä½†æ˜¯å´ä¸åªæœ‰å®ƒä¸€ä¸ªäººã€‚é™¤äº†å®å’šé¸¡å¤–ï¼Œè¿˜æœ‰å¤§ç‹—å«ï¼Œè§ç¼¸é©¬ï¼Œè¢‹é¼ é¸¡ç­‰æˆå‘˜ï¼Œå…¶ä¸­å¤§ç‹—åš¼æ—¶ä¸æ—¶ä¼šå’Œå“ˆåŸºç±³è”åŠ¨ä¸€ä¸‹ï¼Œè¢‹é¼ é¸¡å’Œè§ç¼¸é©¬å‡ºçŽ°çš„åœºæ™¯åˆ™æ¯”è¾ƒå°‘ï¼Œæˆ‘è§è¿‡çš„æœ‰ç™½è¡£ä½¿è€…éª‘ç€è§ç¼¸é©¬çš„GIFå›¾ï¼Œè€Œè¢‹é¼ é¸¡åˆ™æ²¡æœ‰ä¸€ä¸ªå°è±¡æ·±åˆ»çš„åœºæ™¯ã€‚ä½†æ˜¯å®å’šé¸¡ä¸€äººä¾¿è¶³å¤Ÿæ’‘èµ·æ•´ä¸ªå›¢ä½“äº†ã€‚

è¿™äº›ç®€å•çš„åŽ†å²è®°å½•æ–‡å­—è™½ç„¶é‡è¦ä½†ä¹Ÿä¸é‚£ä¹ˆå…³é”®ï¼Œå€¼å¾—æƒ³ä¸€ä¸‹çš„æ˜¯ï¼Œå¦‚æžœå®å’šé¸¡å’Œå“ˆåŸºç±³éƒ½æ²¡æœ‰å‡ºçŽ°ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸Šç½‘è¿˜èƒ½å¤Ÿåšäº›ä»€ä¹ˆã€‚

åœ¨çœ‹è§†é¢‘çš„æ—¶å€™æˆ‘ä»¬æ²¡æœ‰åŠžæ³•å†è¯´å‡ºå“ˆåŸºXè¿™æ ·çš„è¯ï¼Œä¹Ÿæ²¡æœ‰åŠžæ³•æŠŠå®å’šé¸¡å›¢ä½“çš„å†…æ ¸ä»¥åŠå…¶ä¸­çš„äººç‰©æ˜ å°„åˆ°è§†é¢‘å½“ä¸­ã€‚

è¯´å®žè¯ï¼Œè§†é¢‘å†…å®¹æœ¬èº«æ— èŠçš„è¯ï¼Œé‚£ä¹ˆå°±è¦ç”¨è¯„è®ºåŒºçš„å„ç§è¯´æ–‡è§£å­—æ¥å„ç§æŒ‰æ—¶æ‰¾ä¹å­ï¼Œéµå¾ªæŸç§å¤§éƒ¨åˆ†äººå¹¿æ³›è®¤è¯çš„è®¾å®šæ¥çŽ©æ–‡å­—æ¸¸æˆã€‚ä¸Žè„±å£ç§€ä¸åŒçš„æ˜¯è„±å£ç§€æš—ç¤ºçŽ°å®žç”Ÿæ´»å½“ä¸­çš„è¡Œä¸ºï¼Œä½ ç¬‘äº†è¯´æ˜Žä½ å¬æ‡‚äº†ï¼Œä½ æ˜¯è¿™ä¸ªç¾¤ä½“çš„ï¼Œä½†æ˜¯æ„Ÿè§‰ä¸€ç‚¹ä¹Ÿä¸å¥½ç¬‘ï¼Œä¹Ÿè®¸ä¸€å¼€å§‹å¬å¥½ç¬‘ï¼Œä½†æ˜¯ç¬‘å®ŒåŽä¸å°å¿ƒæƒ³äº†ä¸€ä¸‹ï¼Œæˆ‘å°±è§‰å¾—ä¸å¥½ç¬‘äº†ã€‚å› ä¸ºçŽ°å®žç”Ÿæ´»æ„Ÿè§‰å°±å¾—è®¤çœŸå¯¹å¾…ï¼Œå°±æ˜¯ä¼šæƒ³åŽ»è§£å†³æŽ‰é‚£äº›ä¸œè¥¿ï¼Œæ‰€ä»¥å°±ä¸å¥½ç¬‘äº†ã€‚

äº’è”ç½‘å°±æ˜¯ç”¨æ¥å¨±ä¹çš„ï¼Œå³ä½¿æ˜¯å’ŒçŽ°å®žæœ‰å…³ä½†æ˜¯å¾ˆå®¹æ˜“å°±ä¸ä¼šé‚£ä¹ˆè®¤çœŸï¼Œä¸€ä¸ªä¸ªæ¢—ï¼Œmemeå°±ä»Žåœ°åŸŸé»‘ï¼Œç§æ—æ­§è§†ï¼Œè°©éª‚ï¼Œè´©å–ç„¦è™‘ï¼Œäººèº«æ”»å‡»ç­‰æ¶ä¿—æ–‡åŒ–ä¸­è¯žç”Ÿã€‚

äº’è”ç½‘æ˜¯ä¸ªç²ªå‘ï¼Œä½†åˆä¸å®Œå…¨æ˜¯ï¼Œè¿™ä¸ªè§†é¢‘ä¸‹è¯´ç€å„ç§è¯­è¨€åŠŸèƒ½ä¸§å¤±ä¸€æ ·çš„è¯è¯­ï¼Œä¸‹ä¸€ä¸ªè§†é¢‘å¯èƒ½åˆä¼šçœŸè¯šåœ°å’Œäººäº¤æµã€‚

å®å’šé¸¡å’Œå“ˆåŸºç±³æˆåŠŸåœ°è®©ä¸€èµ·ä¸Šç½‘çš„æˆ‘ä»¬æœ‰å…±åŒè¯é¢˜å¯èŠã€‚

## æ‰¾å·¥ä½œ

çœŸçš„ðŸ‚ðŸºï¼Œè¿˜æœ‰ç§‹æ‹›è¿™ç§ä¸œè¥¿ï¼Œåº”è¯¥æ˜¯è¯´ç§‹æ‹›æ‰æ˜¯é‡ç‚¹ã€‚åœ¨å¤§å››ä¸Šå°±è¦å¼€å§‹æ‰¾å·¥ä½œäº†ï¼Œæœ‰ä¸€ç§åˆä¸­ç”Ÿå‡†å¤‡ä¸­è€ƒçš„æ—¶å€™ç„¶åŽçªç„¶å¾—çŸ¥æ”¹ä¸ºè¦å’Œé«˜ä¸­ç”Ÿä¸€èµ·å‚åŠ é«˜è€ƒçš„æ— åŠ›æ„Ÿã€‚

## clap plugin

how many times the code can be used is a method to realize project

CLAP plugin architecture is indeed based on function pointer structs.

structs in plugin_entry.cpp only are read only once at the beginning of loading by reaper 

Reaper loads DLL â†’ reads clap_entry once â†’ uses factory to create plugin instances â†’ calls function pointers in those instances for all ongoing operations.

When you call CreateMutex(), Windows:

- Creates a mutex object in kernel memory
- Adds an entry to your process's handle table
- Returns the handle number to you

create a track which is this plugin and there is a C4 midi in the track:

clap_entry (one-time DLL load)->
pluginFactory->create_plugin (creates MyPlugin instance)->
pluginClass->init (initializes mutex, calls extensionParams.get_info for each parameter, writes default values to both mainParameters and parameters)->
pluginClass->activate (Reaper tells plugin the sample rate)->
pluginClass->start_processing (Reaper says "get ready to process audio")->MIDI Input â†’ pluginClass.process ->Inside process: PluginProcessEvent sees the NOTE_ON and creates a new Voice with held = true, key = 60 (C4), phase = 0.0f, Adds it to plugin->voices array->PluginRenderAudio loops through all voices, and for each held voice->The mixed audio goes to outputL[index] and outputR[index]->Release the Key:CLAP_EVENT_NOTE_OFF->PluginProcessEvent sets voice->held = false
->next call PluginRenderAudio skips the voice, and it gets deleted from the array

Sample rate = 44,100 Hz means we need 44,100 audio dots per second

Buffer size = 512 samples (typical) means each process call handles 512 dots

So process is called 44,100 Ã· 512 = ~86 times per second (not 44,100 times!)

change the sin volumn in reaper at the same time the midi play continuously:

GUI Thread (Main Thread): You drag the knob in Reaper's interface->Parameter Event: Reaper sends a CLAP_EVENT_PARAM_VALUE event to the plugin->Audio Thread in process: PluginProcessEvent receives the parameter event CLAP_EVENT_PARAM_VALUE->MutexAcquire(plugin->syncParameters); plugin->parameters[i] = valueEvent->value; plugin->changed[i] = true; MutexRelease(plugin->syncParameters);->Immediate Audio Change: In the same process call, PluginRenderAudio uses the new volume->the GUI knob directly controls the audio thread parameters

Just a message stream before render check if the param change  

events have timestamps within each audio buffer. The process buffer might be 512 samples, but events can happen at specific sample positions like:

- Sample 0: Note On C4
- Sample 200: Parameter change (volume = 0.8)
- Sample 400: Note Off C4
- ...

// Process samples 0-199 (Note On active)
i=0, nextEventFrame=0 â†’ process Note On â†’ nextEventFrame=200
PluginRenderAudio(0, 200) â†’ generates C4 sound for 200 samples

// Process samples 200-399 (Parameter change + Note still on)
i=200, nextEventFrame=200 â†’ process param change â†’ nextEventFrame=400
PluginRenderAudio(200, 400) â†’ generates C4 with new volume

// Process samples 400-511 (Note Off)
i=400, nextEventFrame=400 â†’ process Note Off â†’ nextEventFrame=512
PluginRenderAudio(400, 512) â†’ voice.held=false, sound stops but loop do not stop immediatly

```
// render audio bewteen event frame
for (uint32_t i = 0; i < frameCount; ) {  // Process audio samples
    while (eventIndex < inputEventCount && nextEventFrame == i) {
        // Process ALL events that happen at sample position 'i'
        PluginProcessEvent(plugin, event);
        eventIndex++;
    }
    // Render audio from sample 'i' to 'nextEventFrame' with current state
    PluginRenderAudio(plugin, i, nextEventFrame, outputL, outputR);
    i = nextEventFrame;  // Jump to next event position
}
```

Buffer must be filled: Every ~11ms (for 512 samples at 44.1kHz), the audio driver says "I need the next 512 samples!" Whether you have MIDI events or not, those 512 samples must be provided.

when you're not playing anything, Reaper keeps calling .process to fill the audio buffer with silence. The plugin is always "running" as long as the track is active, it's just outputting silence when there are no voices playing.




